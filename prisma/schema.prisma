generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Category {
  id   String  @id @default(cuid())
  name String
  slug String? @unique

  attributes      AttributeDefinition[]
  productVariants ProductVariant[]

  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt
  subcategories Subcategory[]

  @@index([slug])
}

model Subcategory {
  id              String           @id @default(cuid())
  name            String
  slug            String?          @unique
  categoryId      String
  category        Category         @relation(fields: [categoryId], references: [id], onDelete: Cascade)
  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt
  productVariants ProductVariant[]

  @@index([categoryId])
  @@index([slug])
}

model AttributeDefinition {
  id               String  @id
  categoryId       String
  name             String
  key              String  @unique
  dataType         String // "string" | "number" | "boolean" | "enum"
  required         Boolean @default(false)
  analyticsEnabled Boolean @default(false)
  enumValues       Json?

  category Category @relation(fields: [categoryId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model ProductVariant {
  id            String       @id
  categoryId    String
  category      Category     @relation(fields: [categoryId], references: [id], onDelete: Cascade)
  subcategoryId String?
  subcategory   Subcategory? @relation(fields: [subcategoryId], references: [id], onDelete: SetNull)

  attributes_json Json

  mrp                   Float
  default_selling_price Float
  max_discount_percent  Float

  imageUrl String?

  products      Product[]
  purchaseItems PurchaseItem[]
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt

  @@index([categoryId])
  @@index([subcategoryId])
}

model Supplier {
  id        String     @id @default(cuid())
  name      String
  code      String?    @unique
  purchases Purchase[]
  createdAt DateTime   @default(now())
  updatedAt DateTime   @updatedAt
  products  Product[]

  @@index([code])
}

model Product {
  id               String @id @default(cuid())
  sku              String @unique
  productVariantId String
  supplierId       String
  quantityInStock  Int    @default(0)

  productVariant ProductVariant @relation(fields: [productVariantId], references: [id], onDelete: Cascade)
  supplier       Supplier       @relation(fields: [supplierId], references: [id], onDelete: Restrict)
  saleItems      SaleItem[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Sale {
  id          String   @id @default(cuid())
  billNumber  String   @unique
  totalAmount Decimal  @db.Decimal(12, 2)
  soldAt      DateTime @default(now())

  items    SaleItem[]
  payments Payment[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model SaleItem {
  id        String @id @default(cuid())
  saleId    String
  productId String

  quantity  Int
  unitPrice Decimal @db.Decimal(12, 2)
  lineTotal Decimal @db.Decimal(12, 2)

  sale    Sale    @relation(fields: [saleId], references: [id], onDelete: Cascade)
  product Product @relation(fields: [productId], references: [id], onDelete: Restrict)

  createdAt DateTime @default(now())

  @@index([saleId])
  @@index([productId])
}

model Payment {
  id     String @id @default(cuid())
  saleId String

  mode      String // CASH | CARD | UPI
  provider  String? // GPay | PhonePe | Paytm
  amount    Decimal @db.Decimal(12, 2)
  reference String?

  sale Sale @relation(fields: [saleId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())

  @@index([saleId])
}

model Purchase {
  id String @id @default(cuid())

  supplierId String
  supplier   Supplier @relation(fields: [supplierId], references: [id])

  invoiceNo   String? // supplier invoice / challan number
  purchasedAt DateTime @default(now())

  extraCharges Decimal? @db.Decimal(12, 2)
  notes        String?

  items PurchaseItem[]

  createdAt DateTime @default(now())

  @@index([supplierId])
  @@index([purchasedAt])
}

model PurchaseItem {
  id String @id @default(cuid())

  purchaseId String
  purchase   Purchase @relation(fields: [purchaseId], references: [id], onDelete: Cascade)

  productVariantId String
  productVariant   ProductVariant @relation(fields: [productVariantId], references: [id])

  quantity          Int
  unitCost          Decimal @db.Decimal(12, 2)
  effectiveUnitCost Decimal @db.Decimal(12, 2)

  createdAt DateTime @default(now())

  @@index([productVariantId])
  @@index([purchaseId])
}
